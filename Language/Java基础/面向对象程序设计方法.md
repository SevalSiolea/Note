面向对象程序设计是当今主流的编程范式，也是Java语言主要支持的编程范式。它允许程序员在设计项目时，先决定数据的组织方式，再决定数据的交互方式；换言之，先决定数据结构再决定算法。面向对象程序设计很适合编写大型项目。

可是，面向对象程序设计是一种指导思想。虽然不同的语言规定了各自的实现语法，但却并未限制程序员应该如何设计项目和编写程序。这就给程序员提供了很大的灵活性，使程序员可能会编写出不同优劣的程序。设计不周、随意编写的程序不仅关系混乱，难以维护，而且可读性会很差；结果，不仅程序会越来越难以编写，而且还会出现各种各样的错误；程序的糟糕框架已经决定了这些错误是难以修改的，而且还会不断地产生新的错误。最终，程序员必须面临要么重构程序，要么在此基础上困难地编写程序的两难选择。

因此，需要有一些指导思想指示程序员如何进行面向对象程序设计。在编写程序前要进行大型项目的架构设计，决定该项目应该有哪些类，这些类是如何联系和交互的。在编写程序时要采取一些方法，更精细地设计整个项目的结构，并且深入到组织和交互的细节。最后，许多技巧可以帮助程序员更好地编写程序。这些指导思想有赖于程序员的实践和经验，本文正是从实际经验中提取出来的一些方法。

## 一  框架设计

### 1  大型项目必须预先设计框架

大型项目的规模很大，通常会包含几十数百个乃至上千个类，这些类之间的关系和交互是相当复杂的。预先设计框架能够使程序员清楚地理解整个项目的结构，从而大大改善了项目的编码工作，并且对后续的维护和管理相当有利。
磨刀不误砍柴工，设计框架虽然需要很多时间和精力，但是能够很大程度上优化后续工作；如果不设计框架，仅依赖程序员心中的概念编写程序，不仅会使项目框架与理想效果相去甚远，也有损于后续的编码和维护工作。最终有可能程序员不得不重构整个项目，反而浪费了更多的时间。

### 2  迭代式地设计框架

设计框架的过程不是一蹴而就的。一个项目是相当复杂的，没有人能预计该项目需要哪些类，这些类又将怎样联系和交互。有可能实际编写一个类时才发现需要另一个类的功能，或者发现这个类的设计不够合理；更有可能的情况是直到深入了具体的编码细节才发现需要一个方法，这个方法或者要放在一个预先设计好的类中，或者需要设计一个新的类来容纳这个方法。即使在实际编码之前已经完全考虑周全，项目的需求也可能发生变化。

为了解决这种情况，建议的方法是迭代式地设计框架。最初只提供一个最简单的核心框架，然后迭代式地完善这个框架。
最初的框架的唯一要求是简单。首先应当削减那些更好地使用项目的边缘部分，它们可以在之后添加。然后削减那些与其他部分联系不够紧密，对其他部分影响很小的部分。用户交互和持久化存储也可以简单化，只要能够测试框架的效果即可。在最后留下核心框架后，就要考虑是否继续削减；可以分别设计核心框架的不同子集，然后将这些子核心框架联合地设计。最终，最初的框架有可能和整个项目相去甚远，但是这些都不重要；简单是唯一需要考虑的因素。
设计了最初框架之后，有两种方法可以选择。一种方法是先编写程序实现它，然后考虑继续完善框架；另一种方法是先完善整个框架再进行实际的编程工作，发现设计不完善的地方再修改。这两种方法各有优劣，很难说明哪种方法更好，建议两种方法配合使用。

还需要说明的是，以上方法只适合于小型项目和部分中型项目。对于大型项目，类的数量可能有成百上千个，而方法的数目就更多了；在这种情况下需要模块化层次化的架构技术，在本文中就不继续深入了。

### 3  设计框架的实际工作

设计框架的具体工作应该包括：

- 该项目有哪些类，这些类的职责分别是什么。设计类时遵循的首要原则是：一个类只承担一类职责。
- 项目的类之间有什么联系。常见的联系有三种：依赖、聚合、继承。
- 项目的类应该有哪些字段。这与类之间的关系密切相关。
- 项目的类应该有哪些方法。一个类只承担一类职责，而该类的一个方法承担一个具体的职责。不能模糊方法承担的职责，也不能让方法承担过多的职责。在设计方法时还有可能对类的设计作出改动。
- 项目的类之间如何交互。具体地说，一个类的方法应该调用另一个类的哪些方法，或者使用另一个类的哪些对象。在这一步仍然可能对类和方法的设计作出修改。

## 二  编程方法

### 1  关注可变类的私有字段的更改

一个类如果是不可变的，那么使用这样的类通常都不会产生什么问题。再次强调不可变类的判定：只能访问这个类的私有字段，而不能改变这个类的私有字段。这又分为以下几种情况。

- 该私有字段是基本类型，没有提供任何公共方法改变该私有字段的值。注意，公共方法可能调用另一个改变该私有字段的私有方法。
- 该私有字段是不可变类，并且也没有提供任何公共方法改变该私有字段的引用。
- 该私有字段是可变类，这种情况是最复杂的。不能获得该私有字段引用的对象，也没有提供任何公共方法改变该私有字段的内部状态。这样，不可能让该私有字段引用一个新的对象，也不可能改变该私有字段的内部状态。
- 还需要考虑一种复杂的情况。该私有字段是可变类，但为该私有字段引用对象时，有可能另一个变量持有这个对象。例如，任何方法都可以通过调用构造器为该私有字段引用对象，并且自己悄悄地引用该对象，这就会在未来的某个时候出现问题。因此，应该保证该私有字段引用的对象不会被其他变量持有；否则，只能宣布这个类是一个可变类，尽管出错的可能性相当小。

使用可变类的情况更加复杂了。如果可变类提供了公共方法允许改变其内部状态，那么问题有可能出现在任何地方。在这种情况下，应当仔细地追踪那些可能改变私有字段的公共方法，包括构造器。
类的设计者应当清楚，哪些私有字段可能会被改变，而哪些私有字段不可能会改变；哪些私有字段有可能引用一个新的对象，而哪些私有字段会改变其引用对象的内部状态，或者两种情况兼而有之；哪些方法会改变私有字段，又会改变哪些私有字段。
在关注这些改变的时候，应当尽量地作出限制，以类的设计者希望的方式作出改变。在设计类时应当假设类的使用者会正确的使用类，但是也要考虑到类被滥用的情况；即使是类的设计者本人也可能会错误地使用类。

即使方法没有明确地作出改变也不能大意，相反情况有可能会更加复杂。考虑这样的情况：某个私有字段是可变类，没有公共方法改变它的引用或它的内部状态；但是，有公共方法返回了该类持有的对象。这样，就可以改变该对象的状态，从而间接地改变该私有字段。
如果该私有字段是不可变类或基本类型，那么不会有任何问题；如果该私有字段是可变类，那么好的解决办法是返回引用对象的一个深拷贝副本。这一情况也应该通知方法的调用者，让其知道此时只是在访问该私有字段而不能作出任何改变。
不过，若是确实需要返回该私有字段持有的对象，并且对其作出修改，那么就要万分小心。不同于直接改变私有字段的方法，发生错误时只要跟踪该方法的调用就可以了；这种方法返回的对象有可能在程序中被传来传去，最终作出改变并发生错误的地方与方法被调用的地方相去甚远，在这种情况下排查错误是相当困难的。

### 2  使用有意义的标识符

标识符是语言中用于标记某个实体的符号。具体地说，在Java语言中，标识符是类、方法、变量的名称。

标识符不应该随意地命名，而应该使用有意义的命名。标识符能够让程序的编写者或使用者更加清楚地理解实体的作用，从而增强可读性，让人对项目的理解更加清晰。类的标识符应当能表示类的单一职责，方法的标识符应当能表示方法的主要功能，而变量的标识符应当能表示变量的内容和作用。如果标识符足够清晰，只需要编写尽量少的注释甚至不需要注释就可以使代码非常易于理解。为标识符命名时，准确性应当是首要的要求，其次考虑标识符是否足够简短；不能为了简短性舍弃准确性。

在大型项目中，标识符的命名应该有一套统一的规范。这里不过多深入，请参考另一篇文章：标识符规范。

### 3  为方法增加注释

注释是提高可读性的好办法，但是方法注释尤为重要。如果方法设计合理，方法注释完善，方法的使用者就不需要深入阅读方法代码，只根据方法签名和方法注释就可以使用方法。如果方法的设计者希望达成这样的效果，方法注释就尤为重要。不够完善的方法注释有可能将方法的使用者引入歧途；例如，方法可能产生了副作用，而方法的使用者对此一无所知。

Java语言为方法注释提供了有效的支持，这就是Javadoc。Javadoc是为编写文档注释而创建的，但在编写方法注释上也特别有用。Javadoc为方法注释的编写作出了以下指导：

- 简要概括方法的主要功能。
- 详细解释方法的主要功能。
- 说明方法的参数和返回值。
- 说明方法将会抛出的异常。

详细解释方法的主要功能时，应当细心严谨。如果方法设计合理，只承担一个具体的职责，那么向方法的调用者描述方法的主要功能是很容易的。问题在于，方法有可能会产生种种副作用，如果无法避免，就必须细心地告知方法的调用者。方法的副作用可能有：

- 向方法传递参数时，如果没有拷贝对象，共享对象可能会出问题。
- 方法可能调用了另一个有副作用的方法，从而使该方法也有副作用。例如，方法可能调用了一个类的方法，这个方法可能会改变该类对象的状态。
- 方法应该对它的依赖格外小心，这些依赖包括：访问了某个私有字段，调用了某个公共方法，访问了某个数据库或配置文件。只要访问了这些依赖就有可能改变这些依赖的状态。从理论上来说，如果一个方法不与外界进行任何交互，不接受任何参数，把所有的工作都在方法内部完成，那么这样的方法就是绝对安全的，肯定不会有副作用；但是这样的情况太过理想，因此对于这些依赖就要格外小心。在方法注释中要列出值得警惕的依赖，当然最好还是由方法的设计者确保不会出现问题。

说明方法的参数时，对于每一个参数：

- 说明该参数的内容和作用，说明方法会如何使用这些参数执行操作。
- 说明该参数是否允许为空，如果为空会如何处理参数。
- 说明该参数的预处理。数组需要预先排序，字符串需要符合某种格式，等等。
- 说明传递该参数时，是否需要先拷贝对象再传递。让对象共享可能会产生某些副作用。

说明方法的返回值时：

- 说明返回值的内容和作用。说明方法会如何执行操作生成这个返回值。
- 如果方法会处理不同的情况，在不同的情况下执行不同的操作并返回不同的值，对所有情况的返回值都要加以说明。
- 说明返回值的可能范围。如果希望用某些特殊值代表某些特殊情况，务必说明。

说明方法抛出的异常时：

- 说明该方法将会抛出哪些异常，异常规范有可能不明确。
- 说明异常将会在什么情况下抛出。
- 说明异常的错误信息和错误码。
- 指示方法的调用者应该如何捕获并处理异常。

要说明的是，以上都只是建议而不是规范。事实上，大多数情况下都用不到大多数建议，方法的注释可以非常简单。

### 4  用注释行区分类的不同部分

一个大型的类可能有许多不同的部分，例如私有字段、公共方法、私有方法。方法过多时又可能加以区分，分为不同重要性和不同功能的方法。因此，有必要区分这些不同的部分。一个建议是使用注释行。

作者风格的注释行是如下构造的：注释行有三行，取块注释，即`/*`和`*/`分隔的注释；大部分语言都支持块注释，语法也是类似的。第二行注释中有64个等号`=`，等号中间说明这一部分的内容，首尾有空格。第一行和第三行注释中全为等号，与第二行注释的长度相同。例如，以下是一个较短的注释分界符示例：

```java
/*==========================================*/
/*================ public method ================*/
/*==========================================*/
```

在一个部分中如果希望继续分隔，可以使用内容全为连接符的长度相同的块注释：

```java
/*------------------------------------------*/
```

作者还习惯于让注释分界符与代码之间相隔两行。

类可以分为如下所述的不同部分：

- 静态区，常量区：`static field`
- 私有字段区：`private field`
- 构造器区：`constructor`
- 公共方法区：`public method`
- 私有方法区：`private method`
- 内部类区：`inner class`

### 5  重点关注对象传递

Java的参数传递是按值传递的。这意味着调用一个方法并向该方法传递了一个对象时，可能会让多个变量引用同一个对象，这有可能会很麻烦。

如果对象是可变的，该对象有可能被方法修改，有可能被方法传递到其他地方并发生修改，不仅会出现错误而且错误很难排查。在这种情况下，考虑使用对象的`clone()`方法，先拷贝对象再传递对象。

如果对象是基本类型或不可变类，那么基本上不会出现什么问题。变量能做的事情只是改变它引用的对象，这不会对其他变量暗中产生影响；即使多个变量引用了同一个对象也不会有问题。

### 6  更好地设计方法

设计类时要让类承担一类具体的职责，而在设计方法时要让方法承担一个具体的职责。这里的要点是：

- 方法的职责一定要和类的职责相匹配，只在类内部就能完成方法的工作。
- 方法的职责务必明确，不能模糊。
- 方法只应该承担一个职责，不要让一个方法承担多个职责。

项目中的所有方法相互调用，可以将其视为一棵方法调用树。对此有以下建议：越浅层的方法应当越抽象简单，越深层的方法应当越具体复杂；浅层的方法尽量只通过调用深层的方法完成它的职责。这样的设计可以让项目的结构更加清晰，浅层的方法可以更好地安排方法调用，而深层的方法可以更好地关注于具体的任务。

设计方法时还有如下建议：

- 如果多个方法包含重复的代码段，最好将其抽离为一个方法，增强复用性和可读性。
- 按需要覆盖`Object`类的`equals()`方法，`toString()`方法，`clone()`方法，`hashCode()`方法等常用方法。

## 三  实用技巧

### 1  提供多种类型的构造器

可以以更加丰富的方式提供构造器。以下构造器的设计方法都是建议，是否要采用取决于类的设计者。

- 全参数构造器：在构造器中指定所有参数。
- 无参数构造器：在构造器中不能指定任何参数，所有私有字段的初始值都由构造器指定。提供无参数构造器常常是一个好主意，但是要仔细考虑私有字段的初始值。
- 部分参数构造器：在构造器中指定部分参数，这是最常见的构造器。
- 复制构造器：提供同一类型的另一个对象作为参数，拷贝该对象的状态以构造对象。这一类构造器最好和`clone()`方法共同使用，并尽量实现为深拷贝。
- 数组构造器：如果类是集合类型，可以提供一个数组构造器，用数组的元素来初始化该集合对象。也可以接受其他集合类型作为参数，如`ArrayList`或`HashSet`。
- 静态方法构造器：不是调用构造器而是调用类的静态方法，该方法将会返回一个新构造的对象。
- 私有构造器：非常少见，不过在枚举类型中常常能够看到。

### 2  静态对象池

静态对象池很像枚举类型，但更加灵活和丰富。静态对象池适用于这样的场景：

- 不希望类的使用者随意地调用构造器构造对象。这可能是因为不希望对象的私有字段被随意地赋值，而只能以类的设计者指定的方法赋值。
- 同一个类的状态相同的对象只能同时存在一个。
- 该类已经提供了一些对象，类的使用者若要使用对象，只能从这些对象中选择。

例如，有一个商品类，商品的信息保存在某个配置文件或数据库中。项目启动时，用配置的商品信息初始化若干商品对象，而商品类的使用者只能从对象池中取得商品对象。这种情况就很适用静态对象池的技巧。

创建静态对象池的要点如下：

- 提供一个私有构造器。私有构造器仅用于本类初始化对象，而不提供给外界使用。当然，提供一个私有静态方法来构造对象也是可行的。
- 声明一个静态集合类的变量，例如`ArrayList`或`HashSet`，集合的元素类型是本类。该变量可以是公共的也可以是私有的，如果是公共的则要多加小心，因为大多数集合类是灵活性很大的可变类；即使对象的状态不能改变，变量的使用者也可以轻松地丢弃对象甚至清空集合。不过，可以预计类的使用者不会这样这样随意使用，因此也不必提供太严格的限制。
- 初始化该变量。该变量在声明时会被初始化为一个空集合对象，需要向集合中添加对象以初始化。可以提供一个静态初始化块，其中还可以调用静态方法。静态方法可以是私有的也可以是公共的；只要确保它仅完成集合的初始化，将其设置为公共的就不会有什么问题。初始化时要调用第一步提供的私有构造器。
- 提供一个公共静态方法以获取对象。例如，可以提供对象的标识符作为参数，方法负责在静态对象池中查找对象，并将其返回。可以不拷贝对象直接返回，这样有利于用相等运算符比较对象。
- 提供一些公共方法访问对象状态。是否要将类设计为不可变的取决于设计者，不过大多数情况下都是不可变的。
- 对象的信息可以从该类的一个表中读取，也可以从配置文件或数据库中读取，取决于具体的实现。

### 3  创建特定的空对象

空值`null`在任何语言中都很难处理。这意味着经常需要考虑检测空值，使代码变得臃肿；有时还会触发一个空指针异常，使得程序意外结束。可是，尽管尽力避免空值，有些时候还是需要返回一个空值作为特殊情况的标识。在这种情况下，使用空对象也许是一个好主意。

空对象是类创建的一个静态对象，通常它还被声明为`public final`的。这个空对象的状态或者被赋初始值，或者被赋一个没有意义的值，还可以被赋另一个类的空对象；这并不重要，因为只要能够识别出空对象即可，几乎不会使用这个空对象的状态。当一个方法处理某些特殊情况而需要返回特殊值时，就可以返回这个空对象；方法的调用者只需要用相等运算符或`equals()`方法检测返回的对象是否是空对象即可，不需要处理空值，避免了麻烦。

空对象的使用有很多好处，但是也有一些缺点，在下面列出：

- 避免编写处理空值的代码，使代码更加简洁。虽然很多时候还是要编写代码检测空对象，可是也有很多代码可以简化。
- 避免出现空指针异常，这既是优点也是缺点。优点是，程序不会异常地终止；而缺点是，有时候确实需要抛出异常以告知程序员有错误，但若使用空对象，错误有可能悄悄地发生，这使得错误很难排查。
- 可以处理多种特殊情况。可能想要在多种特殊情况下都不返回一个正常的对象，但`null`值不能区分不同的特殊情况。在这种情况下只要使用多个空对象就可以了。
- 初始化私有字段时很好用。私有字段的默认初始值为空值。如果想要初始化该私有字段，不想赋空值但又不知道应该引用什么初始对象，就可以为其赋予一个空对象。

### 4  使用启动器类

可以为项目编写一个启动器类。启动器类不应该承担过多的职责，它唯一的任务是启动项目，不需要也不应该承担任何具体的工作。在理想情况下，启动器类只有一个`main()`方法，通过几行简单的代码启动整个项目。使用启动器类可以让用户知道如何启动项目。启动器类可以更复杂一些，除`main()`方法以外还有一个启动方法。在这种情况下如何安排代码取决于启动器类的设计者。

启动器类通常需要配置项目启动的参数，这些参数可能需要从用户输入收集。在这种情况下，可以考虑分离一个方法专门用于收集用户输入。

可以有多个启动器类，每个启动器类至少有一个`main()`方法。这些启动器类允许用户以不同的方式和不同的初始配置启动项目，还可能允许用户以不同的方式使用项目。

### 5  更好地使用枚举类型

Java中枚举类型的使用相当灵活。可以如下所述更好地使用枚举类：

- 枚举类型可以有自己的私有字段，建议声明为`private final`。私有字段使每个枚举值附加了一些信息。
- 枚举类型可以有自己的构造器。构造器自动为`private`，只在枚举类构造枚举值时使用。
- 枚举类型是`Enum`类的子类，因而继承了这个类的许多有用方法。常用有`toString()`方法，`name()`方法，`valueOf()`方法，`values()`方法，`oridinal()`方法，等等。
- 可以在枚举类型中增加方法。例如，可以增加枚举类型的私有字段的访问器方法。

使用枚举类型时，建议将枚举类型单独放置在一个文件中，就如同使用普通类型一样。当枚举类型过多时，可以将枚举类型放在一个包中。

枚举类型的一个用途是处理错误输入、错误输出、程序异常。每个程序异常可以用一个枚举值表示，该枚举值还附加异常码和异常信息，存放在枚举类型的私有字段中。如果不希望创建很多的异常类，这样的枚举类型就很有用处。

静态常量类和枚举类型非常相似。可以声明一些静态常量，并将其放在一个公共类中，这样做很像使用一个枚举类型。静态常量类不如枚举类型灵活，但它使用起来更加简单。在这两种情况下应当仔细地做出选择。