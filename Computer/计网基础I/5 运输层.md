## 一  知识结构

#### 1  运输层的作用

1.1  运输层的作用
1.2  端口
1.3  运输层的两个主要协议
1.4  用户数据报协议UDP
	1.4.1  UDP的主要特点
	1.4.2  UDP的首部格式
1.5  传输控制协议TCP介绍
	1.5.1  TCP的主要特点
	1.5.2  套接字

#### 2  传输控制协议TCP

2.1  可靠传输原理
	2.1.1  理想传输
	2.1.2  停止等待协议
	2.1.3  连续ARQ协议
2.2  TCP的首部格式
	2.2.1  TCP的控制位
	2.2.2  TCP的首部选项
2.3  TCP的可靠传输
	2.3.1  滑动窗口
	2.3.2  超时重传时间的选择
	2.3.3  选择确认SACK
2.4  TCP的流量控制
2.5  TCP的拥塞控制
	2.5.1  拥塞控制原理
		2.5.1.1  网络拥塞
		2.5.1.2  拥塞控制和流量控制
		2.5.1.3  拥塞控制原理
	2.5.2  TCP的拥塞控制方法
		2.5.2.1  慢开始和拥塞避免
		2.5.2.2  快重传和快恢复
		2.5.2.3  TCP的拥塞控制流程图
	2.5.3  主动队列管理AQM
		2.5.3.1  随机早期检测RED
2.6  TCP的连接管理
	2.6.1  三次握手
	2.6.2  四次挥手
	2.6.3  TCP的有限状态机

## 二  主要内容

​	运输层的主要作用是：在网络层的基础上，为应用进程之间的通信提供服务。具体地说，运输层的任务主要有三个。其一，为两台主机的应用进程之间的通信提供服务。其二，为应用进程通信复用和分用网络层。其三，为应用进程通信屏蔽网络层的逻辑具体细节，并提供逻辑通信服务。总而言之，运输层向应用层屏蔽了网络层的具体细节，为两台主机的应用进程之间的通信提供逻辑通信服务，使应用进程好像在一条端到端的逻辑通信信道上进行通信。
​	运输层使用端口标记逻辑通信的两端。端口是由计算机的操作系统生成的抽象接口，16位端口号唯一地标记了一台计算机的端点，运输层将特定端口识别为逻辑通信的端点。

​	运输层的两个主要协议是用户数据报协议UDP和传输控制协议TCP。UDP提供无连接的、尽最大努力交付的传输服务，面向报文且不提供拥塞控制；TCP提供面向连接的可靠传输服务，面向字节流传输，并提供了流量控制、拥塞控制、连接管理等功能。UDP比TCP简单得多，因而报文首部开销小，实现也更容易；此外，UDP也适合允许一定差错的实时通信服务。TCP使用套接字标记逻辑通信的端点，所谓套接字由端口号拼接到IP地址得出，它可以唯一地标记互联网上的某台主机的某个应用进程。由于TCP的工作原理比较复杂，因此本章的其余部分都介绍可靠传输和TCP协议。

​	在理想条件下，传输信道不产生任何差错，接收方也总是来得及接收并处理发送方发送的数据。在这样的理想条件下，不需要采取任何措施即可实现可靠传输。理想传输是不存在的，但可以通过使用一些可靠传输协议，使得最终的效果相同。出现传输差错时，接收方让发送方重传出现差错的数据；同时在接收方来不及接收数据时，告知发送方适当降低发送数据的速率。这样就可以在不可靠的传输信道上实现可靠传输。停止等待协议是最简单的可靠传输协议，它也是TCP协议的基础。
​	停止等待协议的基本原理是：发送方每次发送一个分组，然后停止发送，等待对方的确认，在收到确认后再发送下一个分组。如果发送分组出现差错，接收方就丢弃该分组而不采取任何措施；接收方的确认分组也可能丢失。在这两种情况下，发送方都收不到接收方的确认，在超过一段时间后就会重传分组，这称之为超时重传。其它的情况还有确认丢失和确认迟到等。
​	停止等待协议在发送时间远小于传输时间时信道利用率太差，因而可以使用改进的连续ARQ协议。连续ARQ协议让发送方连续发送多个分组，接收方一次性确认多个连续到达的分组。如果不发生传输差错，发送方就可连续发送分组，因而网络利用率提高了；如果发生传输差错，发送方就必须重传从差错位置开始的所有分组，如果通信质量很差，连续ARQ协议反而会降低网络利用率。

​	TCP的首部格式相当复杂，不过和IP的首部格式很相似。其区别主要在于，TCP是面向字节流传输的，因此在首部有一个32位的字段标记了字节的序号；为实现可靠传输，还需要另一个32位的字段标记了已经成功传输的字节的序号。这两个字段就是序号和确认号。在TCP的首部还有一些控制位。TCP需要对整个报文段计算检验和，计算方式和UDP以及IPv4相似。

​	TCP使用滑动窗口实现可靠传输，基于连续ARQ协议。发送方和接收方各自维护一个滑动窗口，分别称为发送窗口和接收窗口，发送窗口的大小不能超过接收窗口的大小。发送方可连续发送发送窗口内的所有字节，但需要将其暂时保留以备用超时重传。接收方在接收到字节流后，向发送方发送无传输差错的最后一个字节的下一个序号；该序号写入确认号中。发送方收到接收方的确认后，就可以向前推进发送窗口，从确认号指示的字节流开始发送；如果收不到接收方的确认，就需要对所有字节流超时重传。接收方在接收字节流后，也会向前推进接收窗口到确认号指示的字节。因此，在滑动窗口中，发送方和接收方都能够确保滑动窗口已经滑动过的字节流都已经无差错地传输。
​	超时重传时间的选择很重要。基本思想是，根据每个报文段的往返时间RTT不断地调整超时重传时间。Karn算法能够使运输层区分开有效的和无效的往返时间样本，使超时重传时间的估测更加合理。
​	在滑动窗口算法中，只要有部分字节出现了差错，即使后面再次收到了无传输差错的字节流，接收方也会将其丢弃，并从差错位置开始接收字节流。这一措施效率不高，为了改进，可以使用选择确认SACK。接收方在确认报文段的首部选项中告知发送方，有哪些字节流无传输差错，它们的边界在哪里；这样，发送方只要重新发送出现差错的字节流即可。不过，SACK尚无统一的标准，因此大部分实现还是重传所有未被确认的字节流。

​	使用滑动窗口算法可以很容易地实现流量控制。当接收方的接收窗口大小不够时，在确认报文段的窗口字段填入接收窗口的大小，发送方根据此字段调整自己的发送窗口的大小。这样发送方发送的字节流就使接收方来得及接受了。发送窗口也有可能减小到零。

​	在网络中可能会出现拥塞现象。网络拥塞是一个全局性的现象，可能发生在网络的任意位置和任意资源处，并且引起网络拥塞的原因也往往是很难确定的。网络拥塞的本质是网络的各个部分不匹配，因此简单地调整某个部分是不能解决问题的，甚至试图优化网络拥塞的措施反而会使网络拥塞恶化。注意区分拥塞控制和流量控制，前者是一个全局性的问题，而后者是一个端到端的问题。拥塞控制的基本原理是，网络负载越大，网络吞吐量的提升速率会逐渐减小，甚至在网络拥塞严重时，吞吐量反而会减小甚至最终减小到零。因此，拥塞控制要防止过多的数据注入到网络中，使网络的拥塞状态相对平衡。
​	TCP的拥塞控制主要有四种算法，即慢开始和拥塞避免算法，以及快重传和快恢复算法。TCP开始传输时。发送窗口很小。但随后执行慢开始算法，发送窗口会以指数速度增大，并在增大到慢开始门限后执行拥塞避免算法。拥塞避免算法让发送窗口线性增大。在两个算法的执行过程中，一旦出现分组丢失，发送方就认为出现了网络拥塞；此时发送方将发送窗口的大小重置为0，将慢开始门限置为当前发送窗口的一半，并重新执行慢开始和拥塞避免算法。
​	另一种情况是，发送方连续收到来自接收方的三个确认。此时，发送方认为没有发生网络拥塞，而只是出现了个别分组的丢失。于是，发送方重传这个丢失的分组，这称为快重传；发送方将发送窗口的大小重置为当前的一半，并执行拥塞避免算法，这称为快恢复。
​	可以看到，TCP的拥塞控制让发送方的滑动窗口大小连续不断地调整以适应网络情况。以上算法的执行流程可以用图表形式说明。还要说明的是，发送窗口的大小需要综合考虑流量控制和拥塞控制。另外，为了避免路由器的尾部丢弃策略带来的全局同步现象，需要使用主动队列管理AQM。AQM的主要实现算法是RED，不过目前尚无统一的标准。

​	最后来讲解TCP的连接管理，即著名的三次握手和四次挥手。TCP是面向连接的，因此需要建立连接和释放连接。
​	建立连接时，客户端发出连接建立请求；服务端随后给出确认。为了确保服务端的确认到达发送端，客户端还需要回送对确认的确认，这样双方就知道自己的信息都到达了。客户端的连接建立和服务端的确认都要求确认，在收不到确认时需要超时重传，因而三次握手是必需的。
​	释放连接时，由一方先请求，通常是客户端。客户端请求释放连接时，服务端可能还有数据需要发送，因此只能先释放一个方向的连接；于是，只需要一次请求和确认。服务端发送完数据之后，请求释放另一个方向的连接，还需要一次请求和确认。因此，总共需要四次挥手。注意建立连接时需要建立双方向的连接，因此对确认的确认是必需的。也可以理解为服务端将确认和第二次请求一起发送了。
​	以上连接管理和状态转换可以用TCP的有限状态机表示。

## 三  重点梳理

- 理解运输层的作用，理解端口和套接字。
- 理解用户数据报协议UDP和传输控制协议TCP的主要特点。
- 理解并掌握可靠传输的原理，理解并掌握停止等待协议ARQ和连续ARQ协议。
- 理解TCP的可靠传输，理解并掌握TCP如何使用滑动窗口算法实现可靠传输。
- 理解网络拥塞和拥塞控制原理。
- 理解TCP的拥塞控制，理解并掌握TCP进行拥塞控制的时钟算法。
- 理解TCP的连接管理，理解并掌握三次握手和四次挥手，理解并掌握TCP的有限状态机。

## 四  难点解析

#### 1  运输层的作用是什么？

#### 2  比较用户数据报协议UDP和传输控制协议TCP。

#### 3  可靠传输的原理是怎样的？停止等待协议的原理是怎样的？

#### 4  TCP如何使用滑动窗口算法实现可靠传输？TCP如何选择超时重传时间？

#### 5  在TCP中，缓存和窗口的关系是怎样的？

#### 6  TCP如何实现流量控制？

#### 7  什么是网络拥塞现象？如何理解其复杂性？拥塞控制的原理是什么？

#### 8  TCP如何实现拥塞控制？其使用的四种算法是怎样的？

#### 9  什么是主动队列管理AQM？它使用的随机早期检测算法RED是怎样的？AQM如何缓解网络拥塞？

#### 10  TCP如何实现连接管理？三次握手和四次挥手的过程是怎样的？

## 五  重要图表

- P212  运输层的作用
  ![运输层的作用](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\运输层的作用.png)
- P213  使用UDP或TCP协议的各种应用和应用层协议
  ![使用UDP或TCP协议的各种应用和应用层协议](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\使用UDP或TCP协议的各种应用和应用层协议.png)
- P215  常用的熟知端口号
  ![常用的熟知端口号](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\常用的熟知端口号.png)
- P217  UDP的首部格式
  ![UDP的首部格式](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\UDP的首部格式.png)
- **P222 & P223  停止等待协议ARQ**
  ![停止等待协议ARQ_1](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\停止等待协议ARQ_1.png)
  ![停止等待协议ARQ_2](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\停止等待协议ARQ_2.png)
- P224  ARQ和连续ARQ的信道利用率
  ![ARQ的信道利用率](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\ARQ的信道利用率.png)
  ![连续ARQ的信道利用率](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\连续ARQ的信道利用率.png)
- **P226  TCP报文段的首部格式**
  ![TCP报文段的首部格式](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP报文段的首部格式.png)
- **P230 & P231 & P232  滑动窗口算法**
  ![滑动窗口算法_1](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\滑动窗口算法_1.png)
  ![滑动窗口算法_2](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\滑动窗口算法_2.png)
  ![滑动窗口算法_3](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\滑动窗口算法_3.png)
  ![滑动窗口算法_4](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\滑动窗口算法_4.png)
- P232  TCP的缓存和窗口的关系
  ![TCP的缓存和窗口的关系](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP的缓存和窗口的关系.png)
- P235  选择确认SACK
  ![选择确认SACK](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\选择确认SACK.png)
- **P236  TCP的流量控制**
  ![TCP的流量控制](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP的流量控制.png)
- P239  流量控制和拥塞控制的区别
  暂缺
- P240  拥塞控制原理
  ![拥塞控制原理](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\拥塞控制原理.png)
- **P242 & P243 & P244  TCP的拥塞控制**
  ![TCP的拥塞控制_1](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP的拥塞控制_1.png)
  ![TCP的拥塞控制_2](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP的拥塞控制_2.png)
  ![TCP的拥塞控制_3](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP的拥塞控制_3.png)
- **P245  TCP的拥塞控制的流程图**
  ![TCP的拥塞控制的流程图](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP的拥塞控制的流程图.png)
- **P247  三次握手**
  ![三次握手](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\三次握手.png)
- **P249  四次挥手**
  ![四次挥手](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\四次挥手.png)
- **P251  TCP的有限状态机**
  ![TCP的有限状态机](D:\Learn\Note\Computer\计网基础I\Image\5 运输层\TCP的有限状态机.png)

## 六  薄弱点清单



------

