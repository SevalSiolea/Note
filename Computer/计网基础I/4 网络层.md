## 一  知识结构

#### 1  网络层的作用

1.1  网络层的两种服务
1.2  网络层的两个层面
1.3  软件定义网络SDN介绍

#### 2  IP地址

2.1  IP地址的表示方法
2.2  分类的IP地址
2.3  无分类编址CIDR
	2.3.1  网络前缀
	2.3.2  地址块
	2.3.3  地址掩码
	2.3.4  特殊地址块
2.4  IP地址的特点
2.5  IP地址和MAC地址

#### 3  IP协议

3.1  虚拟互连网络
3.2  地址解析协议ARP
	3.2.1  ARP请求响应
	3.2.2  ARP地址解析过程
3.3  IP数据报格式
	3.3.1  数据报分片
3.4  网络层转发分组的过程
	3.4.1  基于终点的转发
	3.4.2  前缀匹配
		3.4.2.1  最长前缀匹配
		3.4.2.2  二叉线索前缀匹配
		3.4.2.3  主机路由和默认路由
	3.4.3  分组转发算法
3.5  网际控制报文协议ICMP
	3.5.1  ICMP报文格式
	3.5.2  ICMP报文分类
	3.5.3  ICMP报文应用
3.6  IPv6
	3.6.1  IPv6数据报格式
	3.6.2  IPv6地址
	3.6.3  IPv4向IPv6过渡
	3.6.4  ICMPv6

#### 4  路由选择

4.1  路由算法设计
4.2  分层次的路由选择协议
4.3  内部网关协议RIP
	4.3.1  RIP的工作原理
	4.3.2  距离向量算法
	4.3.3  坏消息传播得慢
4.4  内部网关协议OSPF
	4.4.1  OSPF的工作原理
	4.4.2  OSPF划分区域
	4.4.3  OSPF的分组
	4.4.4  OSPF的工作过程
4.5  外部网关协议BGP
	4.5.1  BGP环境
	4.5.2  BGP路由
	4.5.3  三种AS
	4.5.4  BGP路由选择
	4.5.5  BGP报文
4.6  路由器
	4.6.1  路由器的结构
	4.6.2  路由器的时延
	4.6.3  路由器的交换结构

#### 5  IP技术

5.1  IP多播
	5.1.1  IP多播的原理
	5.1.2  局域网的硬件多播
	5.1.3  网际组管理协议IGMP
	5.1.4  多播路由选择协议
	5.1.5  IP多播的特点
5.2  虚拟专用网VPN
	5.2.1  本地IP地址
	5.2.2  网络地址转换NAT
5.3  多协议标签交换MPLS
	5.3.1  MPLS的工作原理
	5.3.2  MPLS的工作过程
	5.3.3  转发等价类FEC
	5.3.4  MPLS的报文结构
	5.3.5  段路由选择协议SR
5.4  软件定义网络SDN
	5.4.1  SDN的工作原理
	5.4.2  流表
	5.4.3  SDN的应用
	5.4.4  SDN的体系结构
	5.4.5  SDN控制器

## 二  主要内容

​	网络层是五层协议的体系结构的中间一层，承担着承上启下的重要任务。对上层，网络层提供简单灵活的，无连接的，尽最大努力交付的数据报服务；对下层，网络层需要将不同的单个网络互连成为一个整体的虚拟网络，并屏蔽下层不同网络的具体细节。网络层的核心协议是网际协议IP，它既能在多种类型的网络上运行，也能支持多种运输层和应用层协议，正所谓IP over everything和everything over IP。

​	网络层曾被建议设计为虚电路服务；不过，网络层的设计者考虑到网络层的特点，将网络层设计为数据报服务并沿用至今；互联网的成功证明了这种设计的正确性。网络层有两个层面：数据层面和控制层面。数据层面负责转发在网络层传送的分组，而控制层面负责交换路由信息分组以创建路由表，并导出为转发分组使用的转发表；控制层面是为数据层面服务的，也比数据层面更加复杂。不过近年来，软件定义网络SDN的提出，对网络层的两个层面进行了重大改变。

​	IP地址是IP协议的基本概念。IP协议将不同的单个网络互连成为一个整体的虚拟网络，最大的虚拟互连网络就是互联网；IP地址就是在互联网上，给每一台主机或路由器的每一个接口，分配一个在互联网上唯一的32位标识符。IP地址常用点分十进制记法表示。IP地址由两个字段组成，即网络号和主机号。
​	早期的互联网曾采用分类的IP地址，但随着互联网的发展，这种不合理的IP地址已经被废弃，现在采用的是无分类编址CIDR。CIDR的要点有三个：网络前缀，地址块和地址掩码。首先，CIDR沿用了网络号的概念，但把它的长度定义为可变的，并更名为网络前缀，并使用斜线记法表示网络前缀的长度。其次，CIDR规定相同网络前缀的地址属于同一个地址块。最后，CIDR使用地址掩码，让计算机能够通过IP地址计算网络地址。某些特殊地址块被CIDR保留用作其它用处。
​	IP地址有一些特点。IP地址是一种分等级的地址结构；IP地址是一台主机或路由器的一个接口的标识符；所有的IP地址都是平等的。还要重点区分IP地址和MAC地址的不同。IP地址是在网络层使用的，是一种逻辑地址，是动态分配的；MAC地址是在数据链路层使用的，是一种物理地址，是固化在ROM上的。使用IP地址的目的，正是为了屏蔽不同网络的具体细节，使网络层能够在一个虚拟互连网络上通信。

​	网际协议IP是网络层的核心协议，目前广泛使用的IP协议是IPv4，但正在逐渐向IPv6过渡。在网络层之下，有许多使用不同协议的不同网络；网络层使用相同的IP协议，将这些不同的单个网络互连成为一个整体的虚拟互连网络，使得网络层看来是一个整体统一的网络，而不必关心各个网络的具体异构细节。
​	分组在网络层中转发时，需要交付给数据链路层，而数据链路层需要知道目的MAC地址；ARP协议正是为此而生的，它可以动态地根据IP地址解析得到MAC地址。因此，ARP协议是位于网络层和数据链路层之间的。每一台主机或路由器都有一个ARP高速缓存，存放本局域网上各主机和路由器的IP地址到MAC地址的映射表。当目的表项不存在于ARP高速缓存中时，主机或路由器广播发送ARP请求，并从ARP响应中提取出地址映射放入ARP高速缓存中。ARP使用请求响应动态地解析地址。当网络层转发分组时，ARP自动运行并解析地址，此过程对用户是透明的。
​	IP协议规定了本层数据单元即IP数据报的格式。当IP数据报过长时，还需要进行分片处理。
​	网际控制报文协议ICMP允许主机或路由器报告差错情况和请求回答。ICMP报文主要有两种：差错报告报文和询问报文。PING和跟踪分组是ICMP的典型应用。

​	接下来可以讨论网络层转发分组的过程了。网络层只根据IP数据报的目的地址转发分组，这种转发方式称为基于终点的转发。每一台主机和路由器都在其内部维护一个转发表，存储网络地址到转发接口的映射。路由器转发分组时，将目的IP地址和地址掩码作与运算，并将得到的网络地址与转发表的网络地址逐项匹配，这一过程叫做前缀匹配。采用地址聚合时，可能出现有多项匹配的情况，需要使用最长前缀匹配。为提高前缀匹配的效率，可以使用一些特殊的数据结构如二叉线索树。在此基础上，就可以完整地阐述分组转发算法了。

​	IPv4地址已经耗尽，根本解决措施是使用更大地址空间的新版本的IP，这就是IPv6。IPv6规定了全新的IP数据报格式，灵活、大容量、可扩展，还考虑到当今音频视频文件的数据传输。IPv6地址扩展到128位，需要使用冒号十六进制记法表示，并规定了简单表示的技巧。从IPv4向IPv6过渡是困难的，主要措施是双协议栈和隧道技术。ICMP也推出了全新版本ICMPv6，它融合了IPv4的IGMP协议和ARP协议。

​	路由选择协议规定了互联网中的路由器应如何相互交换信息并生成路由表。设计路由算法时，正确、简单、自适应性、稳定性、公平性应是其首要原则；在此基础上应设计尽量好的路由算法，使得分组平均时延最小而网络的吞吐量最大。由于互联网的规模相当大，并且出于某些单位的私密性考虑，路由选择协议应该设计为两级的：内部网关协议IGP和外部网关协议EGP。常用的内部网关协议有RIP，OSPF等，常用的外部网关协议只有BGP-4。

​	RIP和OSPF都是分布式协议，其共同特点是每个路由器都要不断地和其它路由器交换路由信息。
​	RIP将距离定义为从该路由器到达目的主机或路由器经过的网络数，并认为好的路由是距离更短的路由。RIP规定每个路由器要定期地和相邻路由器交换路由信息，交换的信息是本路由器当前的路由表，并使用距离向量算法更新路由信息。RIP的一个问题是坏消息传播得慢。RIP实现简单且开销较小，因此应用于小型网络。
​	OSPF适用于大型网络。OSPF的基本思想是，使用洪泛法向本自治系统的所有路由器发送路由信息，在本自治系统中维护一个同步的链路状态数据库；路由信息是本路由器已知的链路状态，用度量或代价表示链路状态的某些信息。为减小开销，OSPF将一个自治系统划分为层次化的区域，每个区域只维护本区域的链路状态数据库，而不知道其它区域的网络拓扑结构。OSPF使用五种分组交换路由信息，大部分分组都是为更新链路状态数据库所用的；其中最重要的分组是链路状态更新分组，路由器使用可靠的洪泛法向本区域更新路由信息。由于OSPF灵活、快速，因此广泛应用于大型网络。

​	有了内部网关协议，还需要外部网关协议，它是内部网关协议的黏合剂。由于互联网的规模太大，且自治系统之间的路由选择必须要考虑策略，因此外部网关协议的设计非常复杂。外部网关协议不使用代价而是可达性作为度量，力求找出一条可行路由而不是最佳路由。目前最主要的外部网关协议是BGP-4，使用了路径向量路由选择协议。
​	一个自治系统的路由器BGP分为边界路由器和内部路由器，路由器之间要建立BGP连接才能传送信息。边界路由器之间先相互交换路由信息，再由边界路由器发送给内部路由器。所交换的路由信息是“要到达某个网络，需要经过哪些自治系统，下一跳路由器是哪个路由器”。路由信息路径上的所有边界路由器都存储并更新路由信息。在BGP协议中，有三种AS，即末梢AS，穿越AS和对等AS。BGP规定了一系列策略来试图选择一条较好的路由，如果高级的策略无法选择，再使用低级的策略。最后介绍了BGP的四种报文。

​	路由器是网络层的核心节点，其转发分组功能是网络层的主要工作。一台路由器由路由选择部分和分组转发部分构成，路由选择部分的任务是根据路由选择协议构造路由表，同时通过经常和其它路由器交换路由信息来维护路由表；分组转发部分的任务是根据路由表生成转发表，并根据转发表转发分组。很多时候并不区分路由表和转发表。在路由器接收分组和发送分组都会产生一定的时延，甚至可能丢失分组。交换结构是路由器的分组转发部分的核心结构，最早的交换结构类似于普通的计算机。现在的交换结构主要有存储式、共享总线式、互连网络式三种结构。

​	IP多播适用于一对多的通信。多播数据报只需由源节点发送一次，各路由器会自动复制多播数据报并将其发送出去，在到达局域网时使用硬件多播。IP多播需要在多播数据报的首部写入多播组的标识符作为目的地址，其实就是D类地址。局域网在数据链路层可以完成硬件多播，不需要复制多播数据报，也不需要多播协议。IP多播主要需要网际组管理协议IGMP和多播路由选择协议。IGMP让连接在局域网上的多播路由器知道本局域网上是否有主机参加或退出了某个多播组，多播路由器不会也不需要知道参加该多播组的具体主机；IGMP经过了仔细的设计以避免增加开销。多播路由器还需要和互联网上的其他多播路由器协同工作，这就是多播路由选择协议的工作。多播路由选择协议主要有三种技术：洪泛与剪除、隧道技术、基于核心的发现技术。不过，目前还没有在整个互联网范围使用的多播路由选择协议。

​	专用网是某个单位或机构建立的互连网络，专用网内的主机用本地IP地址而非全球IP地址进行通信。专用网既能节省IP地址又考虑到了网络的私密性。如果专用网使用互联网作为通信载体，就是建设了虚拟专用网VPN。VPN使用互联网在不同地点的专用网之间通信，通信数据需要经过加密和解密，使得效果上就好像在一个专用网上进行通信。个人计算机如果想要接入VPN，可以使用远程接入VPN技术。
​	可是某些时候专用网内部的一些主机又想和互联网通信，这就要用到网络地址转换NAT。专用网上至少有一台路由器连接到互联网，并且拥有若干个全球IP地址。当专用网主机和互联网通信时，NAT路由器负责完成本地IP地址和全球IP地址的转换。这种通信只能由专用网主机发起，并且可通信的主机数目受到NAT的全球IP地址数目的限制。

​	多协议标签交换是一种IP增强技术。其基本原理是：在分组进入MPLS域时，路由器会为分组打上标签，打上标签的分组可以在MPLS域中由路由器在数据链路层使用硬件转发。MPLS域同时支持路由选择和标签交换两种分组转发方式，在进行标签交换时，路由器根据标签交换路径构造转发表，并使用分组的标签对其转发。MPLS的重要概念是转发等价类。使用转发等价类可以支持负载均衡。之后学习了MPLS的报文结构。MPLS比较复杂且运行维护困难，因此出现了新一代的MPLS，即段路由选择协议SR。

​	软件定义网络SDN是一种经过考验的成熟技术，基于SDN的专用广域网有许多优势。SDN的工作原理是将网络层的控制层面和数据层面分离，由SDN控制器和一套网络控制协议监控整个网络的拓扑结构和通信情况并生成转发表，路由器只需要根据转发表转发分组即可。SDN不仅能完成分组转发，还支持地址转换、负载均衡、防火墙等多种功能。SDN用流表代替了路由表，流表基于流转发分组，并提供完成以上功能的信息。SDN体系结构可分为SDN交换机、SDN控制器、网络控制应用程序三大部分，SDN控制器是核心部分，通过北向API和南向API和其他两大部分交互。

## 三  重点梳理

- 理解网络层的作用，理解网络层的两个层面。
- 理解并掌握无分类编址CIDR，理解IP地址的特点。
- 理解地址解析协议ARP，理解并掌握ARP请求响应过程，理解并掌握ARP地址解析过程。
- 理解IP数据报格式，包括IPv4数据报和IPv6数据报。
- 理解并掌握网络层转发分组的过程，理解并掌握前缀匹配过程，理解并掌握分组转发算法。
- 理解内部网关协议RIP和OSPF，理解外部网关协议BGP。理解并掌握它们的工作原理、工作过程和路由算法。
- 理解路由器的结构和工作原理。
- 理解IP多播的原理和特点，理解网际组管理协议IGMP和多播路由选择协议。
- 理解虚拟专用网VPN和网络地址转换NAT。
- 理解多协议标签交换MPLS的工作原理和工作过程。
- 理解并掌握软件定义网络的工作原理和体系结构，理解SDN控制器。

## 四  难点解析

#### 1  网络层的虚电路服务和数据报服务是怎样工作的？它们对比有什么优劣势？

#### 2  网络层有什么作用？

#### 3  无分类编址CIDR是怎样对IP地址编址的？

#### 4  IP地址有什么特点？IP地址和MAC地址的区别与联系是什么？

#### 5  如何对IPv4数据报分片？

#### 6  什么是地址解析协议ARP？它是如何工作的？

#### 7  网络层如何转发分组？

#### 8  前缀匹配过程是怎样的？如何优化前缀匹配过程？

#### 9  内部网关协议RIP使用了什么路由算法？其工作原理和工作过程是怎样的？

#### 10  内部网关协议OSPF使用了什么路由算法？其工作原理和工作过程是怎样的？

#### 11  外部网关协议BGP使用了什么路由算法？其工作原理是怎样的？

#### 12  试比较三种路由选择协议RIP、OSPF、BGP。

#### 13  试比较路由表和转发表。

#### 14  IP多播的原理是怎样的？它有什么特点？网际组管理协议IGMP和多播路由选择协议起到了什么作用？

#### 15  虚拟专用网VPN的实现原理是怎样的？什么是网络地址转换NAT？

#### 16  阐述多协议标签交换MPLS的工作原理和工作过程。

#### 17  什么是软件定义网络SDN？其工作原理是怎样的？其体系结构是怎样的？重点解释SDN控制器。

## 五  重要图表

- P117  虚电路服务和数据报服务的对比
  ![虚电路服务和数据报服务的对比](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\虚电路服务和数据报服务的对比.png)
- P118  软件定义网络SDN介绍
  暂缺
- P121  虚拟互连网络
  ![虚拟互连网络](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\虚拟互连网络.png)
- P123  点分十进制记法
  ![点分十进制记法](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\点分十进制记法.png)
- P124  分类的IP地址
  ![分类的IP地址](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\分类的IP地址.png)
- P124  分类的IP地址中一般不指派的特殊IP地址
  ![分类的IP地址中一般不指派的特殊地址](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\分类的IP地址中一般不指派的特殊地址.png)
- **P129  CIDR地址块划分举例**
  ![CIDR地址块划分举例](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\CIDR地址块划分举例.png)
- P132  IP地址和MAC地址
  ![IP地址和MAC地址](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\IP地址和MAC地址.png)
- **P135  ARP地址解析过程**
  ![ARP地址解析过程](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\ARP地址解析过程.png)
- **P136  IPv4数据报的格式**
  ![IPv4数据报的格式](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\IPv4数据报的格式.png)
- **P138  IPv4数据报的分片**
  ![IPv4数据报的分片](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\IPv4数据报的分片.png)
- P139  IPv4数据报的首部检验和的计算过程
  ![IPv4数据报的首部检验和的计算过程](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\IPv4数据报的首部检验和的计算过程.png)
- P142  最长前缀匹配
  暂缺
- P145  二叉线索前缀匹配
  ![二叉线索前缀匹配](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\二叉线索前缀匹配.png)
- P146  ICMP报文的格式和类型
  ![ICMP报文的格式](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\ICMP报文的格式.png)
  ![ICMP报文的类型](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\ICMP报文的类型.png)
- **P150 & P151  IPv6数据报的格式**
  ![IPv6数据报的格式_1](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\IPv6数据报的格式_1.png)
  ![IPv6数据报的格式_2](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\IPv6数据报的格式_2.png)
- P154  IPv6的常用地址
  ![IPv6的常用地址](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\IPv6的常用地址.png)
- P156  使用隧道技术从IPv4向IPv6过渡
  ![使用隧道技术从IPv4向IPv6过渡](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\使用隧道技术从IPv4向IPv6过渡.png)
- P157  ICMPv6报文的分类
  ![ICMPv6报文的分类](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\ICMPv6报文的分类.png)
- P163  RIP的坏消息传播得慢
  ![RIP的坏消息传播得慢](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\RIP的坏消息传播得慢.png)
- P165  OSPF划分区域
  ![OSPF划分区域](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\OSPF划分区域.png)
- P167  OSPF的可靠的洪泛法
  ![OSPF的可靠的洪泛法](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\OSPF的可靠的洪泛法.png)
- P170  BGP在iBGP和eBGP上运行
  暂缺
- P171  BGP的路由转发
  暂缺
- P171  三种AS
  暂缺
- **P175  路由器的结构**
  ![路由器的结构](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\路由器的结构.png)
- **P177  路由器的时延**
  ![路由器的时延_1](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\路由器的时延_1.png)
  ![路由器的时延_2](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\路由器的时延_2.png)
- P178  路由器的交换结构
  ![路由器的交换结构](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\路由器的交换结构.png)
- P184  反向路径广播RPB和剪除
  ![反向路径广播RPB和剪除](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\反向路径广播RPB和剪除.png)
- **P188  NAT的工作原理**
  ![NAT的工作原理](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\NAT的工作原理.png)
- **P191  MPLS的工作原理**
  ![MPLS的工作原理](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\MPLS的工作原理.png)
- P193  MPLS的报文结构
  ![MPLS的报文结构](D:\Learn\Note\Computer\计网基础I\Image\4 网络层\MPLS的报文结构.png)
- **P198  SDN体系结构**
  暂缺
- P199  SDN控制器
  暂缺

## 六  薄弱点清单



------

